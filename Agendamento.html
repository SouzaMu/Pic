<?php
require_once 'config.php';

// Buscar lista de clientes para exibição na página
$clientes = buscarClientes();
?>
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendamento</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { background-color: #fafafa; }
    .cliente-box {
      background-color: #f3e8ff;
      color: #6f42c1;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      border: none;
    }
    .btn-roxo {
      background-color: #6f42c1;
      border-color: #6f42c1;
      color: #fff;
    }
    .btn-roxo:hover {
      background-color: #5a34a3;
      border-color: #5a34a3;
      color: #fff;
    }
    .btn-outline-roxo {
      color: #6f42c1;
      border-color: #6f42c1;
    }
    .btn-outline-roxo:hover {
      background-color: #6f42c1;
      color: white;
    }
    .date-input { width: 160px; }
    .status-btns .btn { margin: 4px 4px 0 0; }
    .status-btns .btn.active {
      box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.25);
    }
    .service-table th, .service-table td {
      vertical-align: middle;
      text-align: center;
    }
    .bg-roxo { background-color: #6f42c1 !important; }
    .cliente-list {
      max-height: 200px;
      overflow-y: auto;
    }
    .table-hover tbody tr:hover {
      background-color: rgba(111, 66, 193, 0.1);
    }
  </style>
</head>
<body>
  <!-- Navegação -->
  <nav class="navbar navbar-dark bg-roxo mb-4">
    <div class="container">
      <a class="navbar-brand" href="Pagina_inicial.html">← Voltar ao Menu</a>
      <span class="navbar-text">Sistema de Agendamento</span>
    </div>
  </nav>

<div class="container">
  <h4 class="mb-3">Cliente:</h4>
  
  <!-- Formulário de Cadastro -->
  <div class="row g-2 mb-3">
    <div class="col-md-3">
      <input type="text" id="nomeCliente" class="form-control" placeholder="Nome do Cliente" required>
    </div>
    <div class="col-md-3">
      <input type="text" id="telefoneCliente" class="form-control" placeholder="Telefone (opcional)">
    </div>
    <div class="col-md-3">
      <input type="email" id="emailCliente" class="form-control" placeholder="Email (opcional)">
    </div>
    <div class="col-md-3">
      <button id="cadastrarBtn" class="btn btn-roxo w-100">Cadastrar Cliente</button>
    </div>
  </div>

  <!-- Busca e Controles -->
  <div class="row mb-3">
    <div class="col-md-6">
      <div class="input-group">
        <span class="input-group-text"><i class="fas fa-search"></i></span>
        <input type="text" id="buscarCliente" class="form-control" placeholder="Buscar cliente por nome, telefone ou email...">
      </div>
    </div>
    <div class="col-md-6">
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-roxo" onclick="carregarClientes()">
          <i class="fas fa-sync-alt"></i> Atualizar
        </button>
        <button type="button" class="btn btn-outline-roxo" data-bs-toggle="modal" data-bs-target="#clientesModal">
          <i class="fas fa-list"></i> Ver Todos
        </button>
      </div>
    </div>
  </div>

  <!-- Lista de clientes existentes - VERSÃO COMPACTA -->
  <div class="mb-3">
    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#listaClientes">
      <i class="fas fa-chevron-down me-1"></i> Clientes Rápidos (<?= count($clientes) ?>)
    </button>
    <div class="collapse mt-2" id="listaClientes">
      <div class="card card-body">
        <?php if (empty($clientes)): ?>
          <p class="text-muted mb-0"><i class="fas fa-info-circle me-1"></i>Nenhum cliente cadastrado.</p>
        <?php else: ?>
          <div class="row g-2">
            <?php 
            $clientes_rapidos = array_slice($clientes, 0, 8);
            foreach($clientes_rapidos as $cliente): 
            ?>
              <div class="col-md-6">
                <div class="d-flex justify-content-between align-items-center border-bottom py-1">
                  <div class="flex-grow-1">
                    <strong><?= htmlspecialchars($cliente['nome']) ?></strong>
                    <?php if ($cliente['telefone']): ?>
                      <br><small class="text-muted"><?= htmlspecialchars($cliente['telefone']) ?></small>
                    <?php endif; ?>
                  </div>
                  <button type="button" class="btn btn-sm btn-roxo btn-selecionar-cliente" 
                          data-id="<?= $cliente['id'] ?>" 
                          data-nome="<?= htmlspecialchars($cliente['nome']) ?>">
                    Selecionar
                  </button>
                </div>
              </div>
            <?php endforeach; ?>
          </div>
          
          <?php if (count($clientes) > 8): ?>
            <div class="text-center mt-2">
              <small class="text-muted">
                +<?= count($clientes) - 8 ?> clientes não mostrados. 
                <a href="#" data-bs-toggle="modal" data-bs-target="#clientesModal">Ver todos</a>
              </small>
            </div>
          <?php endif; ?>
        <?php endif; ?>
      </div>
    </div>
  </div>

  <div id="clienteInfo"></div>

  <div class="mb-3">
    <label class="form-label">Data:</label>
    <input type="date" class="form-control date-input" value="<?= date('Y-m-d') ?>">
  </div>

  <!-- Tabela de Serviços -->
  <h5 class="mb-2">Serviços</h5>
  <div class="table-responsive">
    <table class="table table-bordered service-table" id="serviceTable">
      <thead class="table-light">
        <tr>
          <th>Serviço</th>
          <th>Profissional</th>
          <th>Tempo (min)</th>
          <th>Início</th>
          <th>Fim</th>
          <th>Valor (R$)</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="serviceBody">
        <tr>
          <td>
            <select class="form-select">
              <option>Barboterapia</option>
              <option>Corte</option>
              <option>Barba</option>
              <option>Hidratação</option>
            </select>
          </td>
          <td>
            <select class="form-select">
              <option>Tiago Melo</option>
              <option>Estevan Araujo</option>
              <option>Alice Azevedo</option>
              <option>Sem Preferência</option>
            </select>
          </td>
          <td><input type="number" class="form-control tempo" value="40"></td>
          <td><input type="time" class="form-control inicio" value="15:40"></td>
          <td><input type="time" class="form-control fim" value="16:20"></td>
          <td><input type="number" class="form-control valor" value="40" min="0" step="0.01"></td>
          <td></td>
        </tr>
      </tbody>
    </table>
  </div>

  <button id="addService" class="btn btn-sm btn-roxo mb-3">Adicionar serviço</button>

  <div class="mb-3">
    <strong>Total (R$): <span id="totalValor">40,00</span></strong>
  </div>

  <div class="mb-3">
    <label class="form-label d-block">Status:</label>
    <div class="status-btns btn-group flex-wrap" role="group" id="statusGroup">
      <button type="button" class="btn btn-outline-primary">Agendado</button>
      <button type="button" class="btn btn-outline-info">Confirmado</button>
      <button type="button" class="btn btn-outline-warning">Aguardando</button>
      <button type="button" class="btn btn-outline-success">Em Atendimento</button>
      <button type="button" class="btn btn-outline-secondary">Finalizado</button>
      <button type="button" class="btn btn-outline-danger">Pago</button>
      <button type="button" class="btn btn-outline-secondary">Cancelado</button>
      <button type="button" class="btn btn-outline-dark">Faltou</button>
    </div>
  </div>

  <div class="d-flex justify-content-end mt-3">
    <button class="btn btn-secondary me-2">Cancelar</button>
    <button class="btn btn-roxo" id="salvarAgendamento">Salvar Agendamento</button>
  </div>
</div>

<!-- Modal para visualizar clientes -->
<div class="modal fade" id="clientesModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-roxo text-white">
        <h5 class="modal-title"><i class="fas fa-users me-2"></i>Clientes Cadastrados (<?= count($clientes) ?>)</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Barra de busca dentro do modal -->
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
              <input type="text" id="buscarClienteModal" class="form-control" placeholder="Filtrar clientes...">
            </div>
          </div>
          <div class="col-md-6 text-end">
            <span class="text-muted">
              <i class="fas fa-info-circle"></i> Clique em "Selecionar" para usar no agendamento
            </span>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Telefone</th>
                <th>Email</th>
                <th>Data Cadastro</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tabelaClientes">
              <?php foreach($clientes as $cliente): ?>
              <tr>
                <td><strong>#<?= $cliente['id'] ?></strong></td>
                <td>
                  <div class="fw-bold"><?= htmlspecialchars($cliente['nome']) ?></div>
                </td>
                <td>
                  <?php if ($cliente['telefone']): ?>
                    <i class="fas fa-phone text-muted me-1"></i>
                    <?= htmlspecialchars($cliente['telefone']) ?>
                  <?php else: ?>
                    <span class="text-muted">-</span>
                  <?php endif; ?>
                </td>
                <td>
                  <?php if ($cliente['email']): ?>
                    <i class="fas fa-envelope text-muted me-1"></i>
                    <?= htmlspecialchars($cliente['email']) ?>
                  <?php else: ?>
                    <span class="text-muted">-</span>
                  <?php endif; ?>
                </td>
                <td>
                  <small class="text-muted">
                    <?= date('d/m/Y', strtotime($cliente['data_cadastro'])) ?>
                  </small>
                </td>
                <td>
                  <button class="btn btn-sm btn-roxo btn-selecionar-modal" 
                          data-id="<?= $cliente['id'] ?>" 
                          data-nome="<?= htmlspecialchars($cliente['nome']) ?>">
                    <i class="fas fa-check me-1"></i>Selecionar
                  </button>
                </td>
              </tr>
              <?php endforeach; ?>
            </tbody>
          </table>
        </div>
        
        <?php if (empty($clientes)): ?>
          <div class="text-center py-5">
            <i class="fas fa-users fa-4x text-muted mb-3"></i>
            <h5 class="text-muted">Nenhum cliente cadastrado</h5>
            <p class="text-muted">Use o formulário acima para cadastrar seu primeiro cliente.</p>
          </div>
        <?php endif; ?>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>Fechar
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Cadastrar cliente via AJAX - VERSÃO CORRIGIDA (SEM RECARREGAR PÁGINA)
  document.getElementById('cadastrarBtn').addEventListener('click', function() {
    const nome = document.getElementById('nomeCliente').value.trim();
    const telefone = document.getElementById('telefoneCliente').value.trim();
    const email = document.getElementById('emailCliente').value.trim();
    
    console.log('Tentando cadastrar:', {nome, telefone, email});
    
    if(!nome){
      alert('Por favor, informe o nome do cliente.');
      return;
    }

    // Mostrar loading
    const btn = this;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'Cadastrando...';
    btn.disabled = true;

    // Usar FormData que é mais confiável
    const formData = new FormData();
    formData.append('acao', 'cadastrar_cliente');
    formData.append('nome', nome);
    formData.append('telefone', telefone);
    formData.append('email', email);

    // Fazer requisição AJAX
    fetch('cadastrar_cliente.php', {
      method: 'POST',
      body: formData
    })
    .then(response => {
      console.log('Status da resposta:', response.status);
      if (!response.ok) {
        throw new Error('Erro na rede: ' + response.status);
      }
      return response.json();
    })
    .then(data => {
      console.log('Resposta do servidor:', data);
      
      if(data.success) {
        alert('✅ ' + data.message);
        
        // Verificar se o elemento existe antes de usar
        const clienteInfo = document.getElementById('clienteInfo');
        if (clienteInfo) {
          clienteInfo.innerHTML = `
            <div class="cliente-box">
              <strong><i class="fas fa-user me-1"></i>Cliente: ${nome}</strong>
              <small class="text-muted ms-2">(ID: ${data.id})</small>
              <button class="btn btn-sm btn-roxo float-end" onclick="abrirComanda(${data.id}, '${nome}')">
                <i class="fas fa-receipt me-1"></i>Abrir Comanda
              </button>
            </div>`;
        }
        
        // Limpar campos
        document.getElementById('nomeCliente').value = '';
        document.getElementById('telefoneCliente').value = '';
        document.getElementById('emailCliente').value = '';
        
        // ✅ ATUALIZAR LISTA SEM RECARREGAR A PÁGINA
        setTimeout(() => {
          atualizarListaClientes();
        }, 500);
        
      } else {
        alert('❌ Erro: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Erro completo:', error);
      alert('❌ Erro ao conectar com o servidor. Verifique o console (F12) para detalhes.');
    })
    .finally(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
    });
  });

  // Função para abrir comanda
  function abrirComanda(clienteId, clienteNome) {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Abrindo...';
    btn.disabled = true;

    const formData = new FormData();
    formData.append('acao', 'abrir_comanda');
    formData.append('cliente_id', clienteId);

    fetch('abrir_comanda.php', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Atualizar o botão para mostrar que a comanda está aberta
        const clienteInfo = document.getElementById('clienteInfo');
        if (clienteInfo) {
          clienteInfo.innerHTML = `
            <div class="cliente-box">
              <strong><i class="fas fa-user me-1"></i>Cliente: ${clienteNome} (ID: ${clienteId})</strong>
              <div class="float-end">
                <span class="badge bg-success me-2">
                  <i class="fas fa-check-circle me-1"></i>Comanda #${data.comanda_id}
                </span>
                <button class="btn btn-sm btn-warning" onclick="abrirGestaoComanda(${data.comanda_id}, ${clienteId}, '${clienteNome}')">
                  <i class="fas fa-edit me-1"></i>Gerenciar
                </button>
              </div>
            </div>`;
        }
        
        // Mostrar toast de sucesso
        mostrarToast('success', `Comanda #${data.comanda_id} aberta para ${clienteNome}`);
        
      } else {
        alert('❌ ' + data.message);
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      alert('❌ Erro ao abrir comanda.');
      btn.innerHTML = originalText;
      btn.disabled = false;
    });
  }

  // Função para abrir gestão da comanda
  function abrirGestaoComanda(comandaId, clienteId, clienteNome) {
    // Abrir em nova aba
    window.open(`comanda_gestao.php?comanda_id=${comandaId}&cliente_id=${clienteId}`, '_blank');
  }

  // Função para mostrar toast
  function mostrarToast(tipo, mensagem) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '1060';
    toast.innerHTML = `
      <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
      ${mensagem}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      if (toast.parentNode) toast.remove();
    }, 5000);
  }

  // Função para atualizar a lista de clientes sem recarregar a página
  function atualizarListaClientes() {
    fetch('buscar_clientes.php')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Atualizar lista rápida
                atualizarListaRapida(data.clientes);
                
                // Atualizar modal
                atualizarModalClientes(data.clientes);
                
                // Atualizar contador
                atualizarContadorClientes(data.clientes.length);
                
                console.log('✅ Lista de clientes atualizada com sucesso!');
            }
        })
        .catch(error => {
            console.error('Erro ao atualizar clientes:', error);
        });
  }

  // Atualizar lista rápida
  function atualizarListaRapida(clientes) {
    const listaContainer = document.querySelector('#listaClientes .card-body');
    if (!listaContainer) return;

    let html = '';
    
    if (clientes.length === 0) {
        html = '<p class="text-muted mb-0"><i class="fas fa-info-circle me-1"></i>Nenhum cliente cadastrado.</p>';
    } else {
        const clientesRapidos = clientes.slice(0, 8);
        html = '<div class="row g-2">';
        
        clientesRapidos.forEach(cliente => {
            html += `
                <div class="col-md-6">
                    <div class="d-flex justify-content-between align-items-center border-bottom py-1">
                        <div class="flex-grow-1">
                            <strong>${escapeHtml(cliente.nome)}</strong>
                            ${cliente.telefone ? `<br><small class="text-muted">${escapeHtml(cliente.telefone)}</small>` : ''}
                        </div>
                        <button type="button" class="btn btn-sm btn-roxo btn-selecionar-cliente" 
                                data-id="${cliente.id}" 
                                data-nome="${escapeHtml(cliente.nome)}">
                            Selecionar
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        if (clientes.length > 8) {
            html += `
                <div class="text-center mt-2">
                    <small class="text-muted">
                        +${clientes.length - 8} clientes não mostrados. 
                        <a href="#" data-bs-toggle="modal" data-bs-target="#clientesModal">Ver todos</a>
                    </small>
                </div>
            `;
        }
    }
    
    listaContainer.innerHTML = html;
  }

  // Atualizar modal de clientes
  function atualizarModalClientes(clientes) {
    const tabela = document.getElementById('tabelaClientes');
    if (!tabela) return;

    let html = '';
    
    clientes.forEach(cliente => {
        html += `
            <tr>
                <td><strong>#${cliente.id}</strong></td>
                <td>
                    <div class="fw-bold">${escapeHtml(cliente.nome)}</div>
                </td>
                <td>
                    ${cliente.telefone ? `
                        <i class="fas fa-phone text-muted me-1"></i>
                        ${escapeHtml(cliente.telefone)}
                    ` : '<span class="text-muted">-</span>'}
                </td>
                <td>
                    ${cliente.email ? `
                        <i class="fas fa-envelope text-muted me-1"></i>
                        ${escapeHtml(cliente.email)}
                    ` : '<span class="text-muted">-</span>'}
                </td>
                <td>
                    <small class="text-muted">
                        ${formatarData(cliente.data_cadastro)}
                    </small>
                </td>
                <td>
                    <button class="btn btn-sm btn-roxo btn-selecionar-modal" 
                            data-id="${cliente.id}" 
                            data-nome="${escapeHtml(cliente.nome)}">
                        <i class="fas fa-check me-1"></i>Selecionar
                    </button>
                </td>
            </tr>
        `;
    });
    
    tabela.innerHTML = html;
  }

  // Atualizar contador de clientes
  function atualizarContadorClientes(total) {
    // Atualizar botão da lista rápida
    const btnLista = document.querySelector('[data-bs-target="#listaClientes"]');
    if (btnLista) {
        btnLista.innerHTML = `<i class="fas fa-chevron-down me-1"></i> Clientes Rápidos (${total})`;
    }
    
    // Atualizar título do modal
    const tituloModal = document.querySelector('#clientesModal .modal-title');
    if (tituloModal) {
        tituloModal.innerHTML = `<i class="fas fa-users me-2"></i>Clientes Cadastrados (${total})`;
    }
  }

  // Funções auxiliares
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatarData(dataISO) {
    if (!dataISO) return '-';
    const data = new Date(dataISO);
    return data.toLocaleDateString('pt-BR');
  }

  // Busca em tempo real na lista principal
  document.getElementById('buscarCliente')?.addEventListener('input', function() {
    const termo = this.value.toLowerCase();
    const linhas = document.querySelectorAll('#listaClientes .col-md-6');
    
    linhas.forEach(linha => {
      const texto = linha.textContent.toLowerCase();
      linha.style.display = texto.includes(termo) ? '' : 'none';
    });
  });

  // Busca em tempo real no modal
  document.getElementById('buscarClienteModal')?.addEventListener('input', function() {
    const termo = this.value.toLowerCase();
    const linhas = document.querySelectorAll('#tabelaClientes tr');
    
    linhas.forEach(linha => {
      const texto = linha.textContent.toLowerCase();
      linha.style.display = texto.includes(termo) ? '' : 'none';
    });
  });

  // Selecionar cliente do modal
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('btn-selecionar-modal')) {
      const id = e.target.getAttribute('data-id');
      const nome = e.target.getAttribute('data-nome');
      
      // Fechar o modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('clientesModal'));
      if (modal) modal.hide();
      
      // Preencher informações do cliente
      const clienteInfo = document.getElementById('clienteInfo');
      if (clienteInfo) {
        clienteInfo.innerHTML = `
          <div class="cliente-box">
            <strong><i class="fas fa-user me-1"></i>Cliente: ${nome} (ID: ${id})</strong>
            <button class="btn btn-sm btn-roxo float-end" onclick="abrirComanda(${id}, '${nome}')">
              <i class="fas fa-receipt me-1"></i>Abrir Comanda
            </button>
          </div>`;
      }
      
      // Marcar como selecionado na lista original (se existir)
      document.querySelectorAll('.btn-selecionar-cliente').forEach(btn => {
        if (btn.getAttribute('data-id') === id) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      
      // Mostrar feedback
      mostrarToast('success', `Cliente "${nome}" selecionado`);
    }
  });

  // Função para recarregar clientes
  function carregarClientes() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Atualizando...';
    btn.disabled = true;
    
    // Atualizar lista
    atualizarListaClientes();
    
    // Restaurar botão
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }, 1000);
  }

  // Selecionar cliente da lista rápida
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('btn-selecionar-cliente')) {
      const id = e.target.getAttribute('data-id');
      const nome = e.target.getAttribute('data-nome');
      const clienteInfo = document.getElementById('clienteInfo');
      
      if (clienteInfo) {
        clienteInfo.innerHTML = `
          <div class="cliente-box">
            <strong><i class="fas fa-user me-1"></i>Cliente: ${nome} (ID: ${id})</strong>
            <button class="btn btn-sm btn-roxo float-end" onclick="abrirComanda(${id}, '${nome}')">
              <i class="fas fa-receipt me-1"></i>Abrir Comanda
            </button>
          </div>`;
      }
      
      // Marcar como ativo
      document.querySelectorAll('.btn-selecionar-cliente').forEach(btn => {
        btn.classList.remove('active');
      });
      e.target.classList.add('active');
    }
  });

  // Sistema de serviços
  const serviceBody = document.getElementById('serviceBody');
  const totalSpan = document.getElementById('totalValor');

  function atualizarTotal() {
    if (!totalSpan) return;
    
    let total = 0;
    serviceBody.querySelectorAll('.valor').forEach(v => {
      total += parseFloat(v.value) || 0;
    });
    totalSpan.textContent = total.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
  }

  if (serviceBody) {
    serviceBody.addEventListener('input', e => {
      if (e.target.classList.contains('valor')) atualizarTotal();
    });
  }

  // Adicionar nova linha
  const addServiceBtn = document.getElementById('addService');
  if (addServiceBtn) {
    addServiceBtn.addEventListener('click', () => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          <select class="form-select">
            <option>Barboterapia</option>
            <option>Corte</option>
            <option>Barba</option>
            <option>Hidratação</option>
          </select>
        </td>
        <td>
          <select class="form-select">
            <option>Tiago Melo</option>
            <option>Estevan Araujo</option>
            <option>Alice Azevedo</option>
            <option>Sem Preferência</option>
          </select>
        </td>
        <td><input type="number" class="form-control tempo" value="30"></td>
        <td><input type="time" class="form-control inicio"></td>
        <td><input type="time" class="form-control fim"></td>
        <td><input type="number" class="form-control valor" value="0" min="0" step="0.01"></td>
        <td><button class="btn btn-sm btn-danger remover">Remover</button></td>
      `;
      if (serviceBody) {
        serviceBody.appendChild(row);
      }
    });
  }

  // Remover linha
  if (serviceBody) {
    serviceBody.addEventListener('click', e => {
      if (e.target.classList.contains('remover')) {
        e.target.closest('tr').remove();
        atualizarTotal();
      }
    });
  }

  // Seleção exclusiva de status
  const statusGroup = document.getElementById('statusGroup');
  if (statusGroup) {
    statusGroup.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        statusGroup.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });
  }

  // Salvar agendamento - VERSÃO CORRIGIDA E SEGURA
  const salvarAgendamentoBtn = document.getElementById('salvarAgendamento');
  if (salvarAgendamentoBtn) {
    salvarAgendamentoBtn.addEventListener('click', function() {
      // Verificar se tem cliente selecionado
      const clienteInfo = document.getElementById('clienteInfo');
      if (!clienteInfo || !clienteInfo.innerHTML.includes('Cliente:')) {
        alert('Por favor, selecione ou cadastre um cliente primeiro.');
        return;
      }

      // Coletar dados do formulário
      const dataInput = document.querySelector('input[type="date"]');
      const data_agendamento = dataInput ? dataInput.value : new Date().toISOString().split('T')[0];
      
      const statusBtn = document.querySelector('#statusGroup .btn.active');
      const status = statusBtn ? statusBtn.textContent.toLowerCase() : 'agendado';
      
      // Coletar serviços
      const servicos = [];
      let clienteId = null;
      
      // Tentar pegar o ID do cliente do botão selecionado
      const clienteSelecionado = document.querySelector('.btn-selecionar-cliente.active');
      if (clienteSelecionado) {
        clienteId = clienteSelecionado.getAttribute('data-id');
      }
      
      // Se não encontrou, pode ser um cliente recém-cadastrado
      if (!clienteId) {
        // Para teste, usar cliente ID 1 (Cliente Teste)
        clienteId = 1;
        alert('Usando cliente padrão para teste. Em produção, selecione um cliente da lista.');
      }

      // Coletar serviços da tabela
      if (serviceBody) {
        serviceBody.querySelectorAll('tr').forEach(tr => {
          const servicoSelect = tr.querySelector('td:nth-child(1) select');
          const profissionalSelect = tr.querySelector('td:nth-child(2) select');
          const tempoInput = tr.querySelector('td:nth-child(3) input');
          const valorInput = tr.querySelector('td:nth-child(6) input');
          
          if (servicoSelect && valorInput) {
            servicos.push({
              servico: servicoSelect.value,
              profissional: profissionalSelect.value,
              tempo: tempoInput ? tempoInput.value : '30',
              valor: valorInput.value || '0'
            });
          }
        });
      }

      if (servicos.length === 0) {
        alert('Adicione pelo menos um serviço.');
        return;
      }

      console.log('Dados do agendamento:', {
        clienteId,
        data_agendamento,
        servicos,
        status
      });

      // Mostrar loading
      const btn = this;
      const originalText = btn.innerHTML;
      btn.innerHTML = 'Salvando...';
      btn.disabled = true;

      // Enviar via AJAX
      const formData = new FormData();
      formData.append('acao', 'salvar_agendamento');
      formData.append('cliente_id', clienteId);
      formData.append('data_agendamento', data_agendamento);
      formData.append('servicos', JSON.stringify(servicos));
      formData.append('status', status);

      fetch('salvar_agendamento.php', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Erro na rede: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        console.log('Resposta do agendamento:', data);
        if (data.success) {
          alert('✅ ' + data.message);
          // Limpar formulário ou redirecionar
          setTimeout(() => {
            window.location.href = 'Coresatt.php';
          }, 2000);
        } else {
          alert('❌ Erro: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        alert('❌ Erro ao salvar agendamento: ' + error.message);
      })
      .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
    });
  }

  // Inicializar total
  setTimeout(atualizarTotal, 100);
</script>

</body>
</html>